This patch is for upstream bug

699255 - Buffer overflow on pprintg1 due to mishandle postscript file data
         to pdf

NOTE : Once we update to GS 9.23 or above, we can drop this patch.

------------------

From: Ken Sharp <ken.sharp@artifex.com>
Date: Wed, 18 Apr 2018 14:46:32 +0000 (+0100)
Subject: pdfwrite - Guard against trying to output an infinite number
X-Git-Url: http://git.ghostscript.com/?p=ghostpdl.git;a=commitdiff_plain;h=39b1e54b2968620723bf32e96764c88797714879;hp=fb4c58a0e097e39547dde3d46893ce1b05d19539

pdfwrite - Guard against trying to output an infinite number

Bug #699255 " Buffer overflow on pprintg1 due to mishandle postscript file data to pdf"

The file uses an enormous parameter to xyxhow, causing an overflow in
the calculation of text positioning (value > 1e39).

Since this is basically a nonsense value, and PostScript only supports
real values up to 1e38, this patch follows the same approach as for
a degenerate CTM, and treats it as 0.

Adobe Acrobat Distiller throws a limitcheck error, so we could do that
instead if this approach proves to be a problem.
---

diff --git a/devices/vector/gdevpdts.c b/devices/vector/gdevpdts.c
index 848ad78..172fe6b 100644
--- a/devices/vector/gdevpdts.c
+++ b/devices/vector/gdevpdts.c
@@ -103,9 +103,14 @@ append_text_move(pdf_text_state_t *pts, double dw)
 static int
 set_text_distance(gs_point *pdist, double dx, double dy, const gs_matrix *pmat)
 {
-    int code = gs_distance_transform_inverse(dx, dy, pmat, pdist);
+    int code;
     double rounded;
 
+    if (dx > 1e38 || dy > 1e38)
+        code = gs_error_undefinedresult;
+    else
+        code = gs_distance_transform_inverse(dx, dy, pmat, pdist);
+
     if (code == gs_error_undefinedresult) {
         /* The CTM is degenerate.
            Can't know the distance in user space.

