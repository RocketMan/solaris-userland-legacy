from
https://gitlab.gnome.org/GNOME/gnome-font-viewer/-/commit/cbe443a8db3b7f09b2653d588c2ddd76d47fa496
https://gitlab.gnome.org/GNOME/gnome-font-viewer/-/commit/4d548988b61aad297219aa5ebfc68158b6d05b18
https://gitlab.gnome.org/GNOME/gnome-font-viewer/-/commit/9661683379806e2bad6a52ce6dde776a33f4f981
https://gitlab.gnome.org/GNOME/gnome-font-viewer/-/commit/519715d9b036563e467c813f69fbefff2042d89d

From cbe443a8db3b7f09b2653d588c2ddd76d47fa496 Mon Sep 17 00:00:00 2001
From: Cosimo Cecchi <cosimoc@gnome.org>
Date: Sun, 1 Dec 2019 14:07:30 -0800
Subject: [PATCH] Move utility to get font name to sushi-font-loader

We'll use this from sushi-font-widget as well.
---
 src/font-model.c        |  3 ++-
 src/font-utils.c        | 11 +----------
 src/font-utils.h        |  1 -
 src/sushi-font-loader.c | 14 ++++++++++++++
 src/sushi-font-loader.h |  3 +++
 5 files changed, 20 insertions(+), 12 deletions(-)

diff --git a/src/font-model.c b/src/font-model.c
index 658cba8..e66c401 100644
--- a/src/font-model.c
+++ b/src/font-model.c
@@ -33,6 +33,7 @@
 
 #include "font-model.h"
 #include "font-utils.h"
+#include "sushi-font-loader.h"
 
 struct _FontViewModel
 {
@@ -137,7 +138,7 @@ font_view_model_has_face (FontViewModel *self,
     g_autofree gchar *match_name = NULL;
 
     n_items = g_list_model_get_n_items (G_LIST_MODEL (self->model));
-    match_name = font_utils_get_font_name (face);
+    match_name = sushi_get_font_name (face, TRUE);
 
     for (idx = 0; idx < n_items; idx++) {
         FontViewModelItem *item = g_list_model_get_item (G_LIST_MODEL (self->model), idx);
diff --git a/src/font-utils.c b/src/font-utils.c
index 5a75fb3..6a41d26 100644
--- a/src/font-utils.c
+++ b/src/font-utils.c
@@ -22,15 +22,6 @@
 
 #include "sushi-font-loader.h"
 
-gchar *
-font_utils_get_font_name (FT_Face face)
-{
-    if (g_strcmp0 (face->style_name, "Regular") == 0)
-        return g_strdup (face->family_name);
-
-    return g_strconcat (face->family_name, ", ", face->style_name, NULL);
-}
-
 gchar *
 font_utils_get_font_name_for_file (FT_Library library,
                                    GFile *file,
@@ -49,7 +40,7 @@ font_utils_get_font_name_for_file (FT_Library library,
         return NULL;
     }
 
-    name = font_utils_get_font_name (face);
+    name = sushi_get_font_name (face, TRUE);
     FT_Done_Face (face);
 
     return name;
diff --git a/src/font-utils.h b/src/font-utils.h
index 6f73bb4..1787bbb 100644
--- a/src/font-utils.h
+++ b/src/font-utils.h
@@ -25,7 +25,6 @@
 #include FT_FREETYPE_H
 #include <gio/gio.h>
 
-gchar * font_utils_get_font_name (FT_Face face);
 gchar * font_utils_get_font_name_for_file (FT_Library library,
                                            GFile *file,
                                            gint face_index);
diff --git a/src/sushi-font-loader.c b/src/sushi-font-loader.c
index f7cf1de..e7da560 100644
--- a/src/sushi-font-loader.c
+++ b/src/sushi-font-loader.c
@@ -172,3 +172,17 @@ sushi_new_ft_face_from_uri_finish (GAsyncResult *result,
 
   return create_face_from_contents (job, contents, error);
 }
+
+/**
+ * sushi_get_font_name: (skip)
+ *
+ */
+gchar *
+sushi_get_font_name (FT_Face face,
+                     gboolean short_form)
+{
+  if (short_form && g_strcmp0 (face->style_name, "Regular") == 0)
+    return g_strdup (face->family_name);
+
+  return g_strconcat (face->family_name, ", ", face->style_name, NULL);
+}
diff --git a/src/sushi-font-loader.h b/src/sushi-font-loader.h
index 82aab03..b078e4a 100644
--- a/src/sushi-font-loader.h
+++ b/src/sushi-font-loader.h
@@ -46,4 +46,7 @@ FT_Face sushi_new_ft_face_from_uri_finish (GAsyncResult *result,
                                            gchar **contents,
                                            GError **error);
 
+gchar * sushi_get_font_name (FT_Face face,
+                             gboolean short_form);
+
 #endif /* __SUSHI_FONT_LOADER_H__ */
-- 
2.24.1

From 4d548988b61aad297219aa5ebfc68158b6d05b18 Mon Sep 17 00:00:00 2001
From: Cosimo Cecchi <cosimoc@gnome.org>
Date: Sun, 1 Dec 2019 14:09:22 -0800
Subject: [PATCH] font-widget: use sushi_get_font_name()

Instead of repeating the same code.
---
 src/sushi-font-widget.c | 3 +--
 1 file changed, 1 insertion(+), 2 deletions(-)

diff --git a/src/sushi-font-widget.c b/src/sushi-font-widget.c
index 144a3d6..ac1fcd4 100644
--- a/src/sushi-font-widget.c
+++ b/src/sushi-font-widget.c
@@ -378,8 +378,7 @@ build_strings_for_face (SushiFontWidget *self)
     self->sample_string = random_string_from_available_chars (self->face, 36);
 
   g_free (self->font_name);
-  self->font_name = g_strconcat (self->face->family_name, " ",
-                                 self->face->style_name, NULL);
+  self->font_name = sushi_get_font_name (self->face, FALSE);
 }
 
 static gint *
-- 
2.24.1

From 9661683379806e2bad6a52ce6dde776a33f4f981 Mon Sep 17 00:00:00 2001
From: Cosimo Cecchi <cosimoc@gnome.org>
Date: Sun, 1 Dec 2019 15:22:25 -0800
Subject: [PATCH] Fallback to basename when no family name (CVE-2019-19308)

Instead of possibly returning an empty string, which will cause
issues later on.

We store the GFile that was loaded to create the FT_Face into its
generic client data structure, and load the basename from it when
we don't have a family name.

https://gitlab.gnome.org/GNOME/gnome-font-viewer/issues/17
---
 src/sushi-font-loader.c | 30 +++++++++++++++++++++++++++---
 1 file changed, 27 insertions(+), 3 deletions(-)

diff --git a/src/sushi-font-loader.c b/src/sushi-font-loader.c
index e7da560..df28c1a 100644
--- a/src/sushi-font-loader.c
+++ b/src/sushi-font-loader.c
@@ -67,6 +67,13 @@ font_load_job_free (FontLoadJob *job)
 
 G_DEFINE_AUTOPTR_CLEANUP_FUNC (FontLoadJob, font_load_job_free)
 
+static void
+face_data_finalizer (void *object)
+{
+  FT_Face face = object;
+  g_clear_object (&face->generic.data);
+}
+
 static FT_Face
 create_face_from_contents (FontLoadJob *job,
                            gchar **contents,
@@ -88,6 +95,9 @@ create_face_from_contents (FontLoadJob *job,
     return NULL;
   }
 
+  retval->generic.data = g_object_ref (job->file);
+  retval->generic.finalizer = face_data_finalizer;
+
   *contents = g_steal_pointer (&job->face_contents);
   return retval;
 }
@@ -181,8 +191,22 @@ gchar *
 sushi_get_font_name (FT_Face face,
                      gboolean short_form)
 {
-  if (short_form && g_strcmp0 (face->style_name, "Regular") == 0)
-    return g_strdup (face->family_name);
+  const char *style_name = face->style_name;
+  const char *family_name = face->family_name;
+
+  if (family_name == NULL) {
+    /* Try to get the basename of the file this was loaded from */
+    GFile *file = face->generic.data;
+    if (G_IS_FILE (file))
+      return g_file_get_basename (file);
+
+    /* Use an empty string as the last fallback */
+    return g_strdup ("");
+  }
+
+  if (style_name == NULL ||
+      (short_form && g_strcmp0 (style_name, "Regular") == 0))
+    return g_strdup (family_name);
 
-  return g_strconcat (face->family_name, ", ", face->style_name, NULL);
+  return g_strconcat (family_name, ", ", style_name, NULL);
 }
-- 
2.24.1

From 519715d9b036563e467c813f69fbefff2042d89d Mon Sep 17 00:00:00 2001
From: Cosimo Cecchi <cosimoc@gnome.org>
Date: Sun, 1 Dec 2019 15:25:36 -0800
Subject: [PATCH] font-view: use basename in header bar when no family name

Instead of displaying an empty header bar, fall back to the basename
of the file we're viewing.
---
 src/font-view.c | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/src/font-view.c b/src/font-view.c
index 2c7e02d..26679cb 100644
--- a/src/font-view.c
+++ b/src/font-view.c
@@ -1033,7 +1033,13 @@ font_widget_loaded_cb (SushiFontWidget *font_widget,
     uri = sushi_font_widget_get_uri (font_widget);
     self->font_file = g_file_new_for_uri (uri);
 
-    gtk_header_bar_set_title (GTK_HEADER_BAR (self->header), face->family_name);
+    if (face->family_name) {
+        gtk_header_bar_set_title (GTK_HEADER_BAR (self->header), face->family_name);
+    } else {
+        g_autofree gchar *basename = g_file_get_basename (self->font_file);
+        gtk_header_bar_set_title (GTK_HEADER_BAR (self->header), basename);
+    }
+
     gtk_header_bar_set_subtitle (GTK_HEADER_BAR (self->header), face->style_name);
 
     install_button_refresh_appearance (self, NULL);
-- 
2.24.1

