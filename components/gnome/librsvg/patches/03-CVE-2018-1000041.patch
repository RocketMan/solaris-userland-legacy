Patch source:
Merge of changes: https://github.com/GNOME/librsvg/commit/c6ddf2ed4d768fd88adbea2b63f575cd523022ea
https://github.com/GNOME/librsvg/commit/4de19d9fdddf81773125b04a4defe1ffd0d3bfe0

From 72a4f0584e08bcb16b189eb8b395e193fdc3f88a Mon Sep 17 00:00:00 2001
From: Federico Mena Quintero <federico@gnome.org>
Date: Mon, 4 Dec 2017 13:06:39 -0600
Subject: [PATCH 01/10] Make _rsvg_handle_allow_load() take a GFile for the
 base uri, not a handle

--- a/rsvg-base.c	2019-08-12 11:02:31.110310820 -0700
+++ b/rsvg-base.c	2019-08-12 11:08:32.070507174 -0700
@@ -2284,16 +2284,17 @@
     g_set_error (error, RSVG_ERROR, 0, _("%s: assertion `%s' failed"), pretty_function, expression);
 }
 
-static gboolean
-_rsvg_handle_allow_load (RsvgHandle *handle,
+gboolean
+rsvg_allow_load (GFile      *base_gfile,
                          const char *uri,
                          GError **error)
 {
-    RsvgHandlePrivate *priv = handle->priv;
     GFile *base;
     char *path, *dir;
     char *scheme = NULL, *cpath = NULL, *cdir = NULL;
 
+    g_assert (error == NULL || *error == NULL);
+
     g_assert (handle->priv->load_policy == RSVG_LOAD_POLICY_STRICT);
 
     scheme = g_uri_parse_scheme (uri);
@@ -2307,11 +2308,11 @@
         goto allow;
 
     /* No base to compare to? */
-    if (priv->base_gfile == NULL)
+    if (base_gfile == NULL)
         goto deny;
 
     /* Deny loads from differing URI schemes */
-    if (!g_file_has_uri_scheme (priv->base_gfile, scheme))
+    if (!g_file_has_uri_scheme (base_gfile, scheme))
         goto deny;
 
     /* resource: is allowed to load anything from other resources */
@@ -2322,7 +2323,7 @@
     if (!g_str_equal (scheme, "file"))
         goto deny;
 
-    base = g_file_get_parent (priv->base_gfile);
+    base = g_file_get_parent (base_gfile);
     if (base == NULL)
         goto deny;
 
@@ -2403,12 +2404,13 @@
                            gsize *len,
                            GError **error)
 {
+    RsvgHandlePrivate *priv = handle->priv;
     char *uri;
     char *data;
 
     uri = _rsvg_handle_resolve_uri (handle, url);
 
-    if (_rsvg_handle_allow_load (handle, uri, error)) {
+    if (rsvg_allow_load (priv->base_gfile, uri, error)) {
         data = _rsvg_io_acquire_data (uri, 
                                       rsvg_handle_get_base_uri (handle), 
                                       content_type, 
@@ -2429,12 +2431,13 @@
                              char **content_type,
                              GError **error)
 {
+    RsvgHandlePrivate *priv = handle->priv;
     char *uri;
     GInputStream *stream;
 
     uri = _rsvg_handle_resolve_uri (handle, url);
 
-    if (_rsvg_handle_allow_load (handle, uri, error)) {
+    if (rsvg_allow_load (priv->base_gfile, uri, error)) {
         stream = _rsvg_io_acquire_stream (uri, 
                                           rsvg_handle_get_base_uri (handle), 
                                           content_type, 
--- a/rsvg-private.h	2019-08-12 11:08:49.424015829 -0700
+++ b/rsvg-private.h	2019-08-12 11:09:21.786780168 -0700
@@ -410,6 +410,11 @@
                                   const char *expression, GError ** error);
 
 G_GNUC_INTERNAL
+gboolean rsvg_allow_load (GFile       *base_gfile,
+                          const char  *uri,
+                          GError     **error);
+
+G_GNUC_INTERNAL
 char *_rsvg_handle_acquire_data (RsvgHandle *handle,
                                  const char *uri,
                                  char **content_type,

From 89c40a0838b35cfc1dd8a93c68589e094ea28516 Mon Sep 17 00:00:00 2001
From: Federico Mena Quintero <federico@gnome.org>
Date: Mon, 4 Dec 2017 13:21:27 -0600
Subject: [PATCH 03/10] rsvg_acquire_data_data(): Remove unused argument

From a3c375ffc85d3759d01841bc7489bddd1876a0da Mon Sep 17 00:00:00 2001
From: Federico Mena Quintero <federico@gnome.org>
Date: Mon, 4 Dec 2017 13:23:17 -0600
Subject: [PATCH 05/10] rsvg_decode_data_uri(): Renamed from
 rsvg_acquire_data_data()

--- a/rsvg-io.c	2019-08-12 11:11:22.800618134 -0700
+++ b/rsvg-io.c	2019-08-12 11:16:38.866448822 -0700
@@ -66,8 +66,7 @@
 #define BASE64_INDICATOR_LEN (sizeof (";base64") - 1)
 
 static char *
-rsvg_acquire_data_data (const char *uri,
-                        const char *base_uri, 
+rsvg_decode_data_uri (const char *uri,
                         char **out_mime_type,
                         gsize *out_len,
                         GError **error)
@@ -313,7 +312,7 @@
         len = &llen;
 
     if (strncmp (href, "data:", 5) == 0)
-      return rsvg_acquire_data_data (href, NULL, mime_type, len, error);
+      return rsvg_decode_data_uri (href, mime_type, len, error);
 
     if ((data = rsvg_acquire_file_data (href, base_uri, mime_type, len, cancellable, NULL)))
       return data;
@@ -342,7 +341,7 @@
     }
 
     if (strncmp (href, "data:", 5) == 0) {
-        if (!(data = rsvg_acquire_data_data (href, NULL, mime_type, &len, error)))
+        if (!(data = rsvg_decode_data_uri (href, mime_type, &len, error)))
             return NULL;
 
         return g_memory_input_stream_new_from_data (data, len, (GDestroyNotify) g_free);

From ea4c0821269ccce62bcaf368f21d9edd0dbd51e8 Mon Sep 17 00:00:00 2001
From: Federico Mena Quintero <federico@gnome.org>
Date: Mon, 4 Dec 2017 18:25:20 -0600
Subject: [PATCH 06/10] rsvg_handle_resolve_uri(): Make public

--- a/rsvg-base.c	2019-08-12 11:17:12.561840149 -0700
+++ b/rsvg-base.c	2019-08-12 11:17:51.325347472 -0700
@@ -2368,8 +2368,8 @@
     return FALSE;
 }
 
-static char *
-_rsvg_handle_resolve_uri (RsvgHandle *handle,
+char *
+rsvg_handle_resolve_uri (RsvgHandle *handle,
                           const char *uri)
 {
     RsvgHandlePrivate *priv = handle->priv;
@@ -2408,7 +2408,7 @@
     char *uri;
     char *data;
 
-    uri = _rsvg_handle_resolve_uri (handle, url);
+    uri = rsvg_handle_resolve_uri (handle, url);
 
     if (rsvg_allow_load (priv->base_gfile, uri, error)) {
         data = _rsvg_io_acquire_data (uri, 
@@ -2435,7 +2435,7 @@
     char *uri;
     GInputStream *stream;
 
-    uri = _rsvg_handle_resolve_uri (handle, url);
+    uri = rsvg_handle_resolve_uri (handle, url);
 
     if (rsvg_allow_load (priv->base_gfile, uri, error)) {
         stream = _rsvg_io_acquire_stream (uri, 
--- a/rsvg-private.h	2019-08-12 11:18:03.750329734 -0700
+++ b/rsvg-private.h	2019-08-12 11:18:35.145336421 -0700
@@ -410,6 +410,10 @@
                                   const char *expression, GError ** error);
 
 G_GNUC_INTERNAL
+char *rsvg_handle_resolve_uri (RsvgHandle *handle,
+                               const char *uri);
+
+G_GNUC_INTERNAL
 gboolean rsvg_allow_load (GFile       *base_gfile,
                           const char  *uri,
                           GError     **error);

From 4de19d9fdddf81773125b04a4defe1ffd0d3bfe0 Mon Sep 17 00:00:00 2001
From: Federico Mena Quintero <federico@gnome.org>
Date: Mon, 4 Dec 2017 18:26:39 -0600
Subject: [PATCH 07/10] rsvg_handle_new_from_file(): Use the GFile machinery to
 convert a filename to a URI

--- a/rsvg-base-file-util.c	2019-08-12 11:18:57.803332703 -0700
+++ b/rsvg-base-file-util.c	2019-08-12 11:19:41.084945232 -0700
@@ -88,12 +88,23 @@
     char *data;
     gsize data_len;
     RsvgHandle *handle = NULL;
+    GFile *file;
 
     rsvg_return_val_if_fail (file_name != NULL, NULL, error);
 
-    base_uri = rsvg_get_base_uri_from_filename (file_name);
-    data = _rsvg_io_acquire_data (file_name, base_uri, NULL, &data_len, NULL, error);
+    file = g_file_new_for_path (file_name);
+    base_uri = g_file_get_uri (file);
+    if (!base_uri) {
+        g_set_error (error,
+                     G_IO_ERROR,
+                     G_IO_ERROR_FAILED,
+                     _("Cannot obtain URI from '%s'"), file_name);
+        g_object_unref (file);
+        return NULL;
+    }
 
+    data = _rsvg_io_acquire_data (base_uri, base_uri, NULL, &data_len, NULL, error);
+
     if (data) {
         handle = rsvg_handle_new ();
         rsvg_handle_set_base_uri (handle, base_uri);

From b49acf81cc50dd5a812c4afb3a5bbf68295d37fe Mon Sep 17 00:00:00 2001
From: Federico Mena Quintero <federico@gnome.org>
Date: Mon, 4 Dec 2017 18:27:59 -0600
Subject: [PATCH 08/10] rsvg_get_base_uri_from_filename(): Make private

--- a/rsvg-base.c	2019-08-12 11:20:04.198166880 -0700
+++ b/rsvg-base.c	2019-08-12 11:20:21.934579100 -0700
@@ -1018,7 +1018,7 @@
     return (p[0] == ':' && p[1] == '/' && p[2] == '/');
 }
 
-gchar *
+static gchar *
 rsvg_get_base_uri_from_filename (const gchar * filename)
 {
     gchar *current_dir;
@@ -1025,7 +1025,6 @@
     gchar *absolute_filename;
     gchar *base_uri;
 
-
     if (g_path_is_absolute (filename))
         return g_filename_to_uri (filename, NULL, NULL);
 
--- a/rsvg-private.h	2019-08-12 11:20:33.752158758 -0700
+++ b/rsvg-private.h	2019-08-12 11:20:51.087010306 -0700
@@ -353,8 +353,6 @@
 G_GNUC_INTERNAL
 gboolean     rsvg_eval_switch_attributes	(RsvgPropertyBag * atts, gboolean * p_has_cond);
 G_GNUC_INTERNAL
-gchar       *rsvg_get_base_uri_from_filename    (const gchar * file_name);
-G_GNUC_INTERNAL
 void rsvg_pop_discrete_layer    (RsvgDrawingCtx * ctx);
 G_GNUC_INTERNAL
 void rsvg_push_discrete_layer   (RsvgDrawingCtx * ctx);

From 5d171cf4f4b3c1e34956c704bb190ca73b90dbb5 Mon Sep 17 00:00:00 2001
From: Federico Mena Quintero <federico@gnome.org>
Date: Mon, 4 Dec 2017 18:28:43 -0600
Subject: [PATCH 09/10] rsvg-io - Don't resolve relative filenames here; do it
 in the caller

--- a/rsvg-io.c	2019-08-12 11:21:14.639637684 -0700
+++ b/rsvg-io.c	2019-08-12 11:24:18.627507108 -0700
@@ -123,56 +123,32 @@
     return data;
 }
 
-gchar *
-_rsvg_io_get_file_path (const gchar * filename,
-                        const gchar * base_uri)
-{
-    gchar *absolute_filename;
-
-    if (g_file_test (filename, G_FILE_TEST_EXISTS) || g_path_is_absolute (filename)) {
-        absolute_filename = g_strdup (filename);
-    } else {
-        gchar *tmpcdir;
-        gchar *base_filename;
-
-        if (base_uri) {
-            base_filename = g_filename_from_uri (base_uri, NULL, NULL);
-            if (base_filename != NULL) {
-                tmpcdir = g_path_get_dirname (base_filename);
-                g_free (base_filename);
-            } else 
-                return NULL;
-        } else
-            tmpcdir = g_get_current_dir ();
-
-        absolute_filename = g_build_filename (tmpcdir, filename, NULL);
-        g_free (tmpcdir);
-    }
-
-    return absolute_filename;
-}
-
 static char *
-rsvg_acquire_file_data (const char *filename,
-                        const char *base_uri,
+rsvg_acquire_file_data (const char *uri,
                         char **out_mime_type,
                         gsize *out_len,
                         GCancellable *cancellable,
                         GError **error)
 {
+    GFile *file;
     gchar *path, *data;
     gsize len;
     char *content_type;
 
-    rsvg_return_val_if_fail (filename != NULL, NULL, error);
+    rsvg_return_val_if_fail (uri != NULL, NULL, error);
     g_assert (out_len != NULL);
 
-    path = _rsvg_io_get_file_path (filename, base_uri);
-    if (path == NULL)
+    file = g_file_new_for_uri (uri);
+    path = g_file_get_path (file);
+
+    if (path == NULL) {
+        g_object_unref (file);
         return NULL;
+    }
 
     if (!g_file_get_contents (path, &data, &len, error)) {
         g_free (path);
+        g_object_unref (file);
         return NULL;
     }
 
@@ -183,6 +159,7 @@
     }
 
     g_free (path);
+    g_object_unref (file);
 
     *out_len = len;
     return data;
@@ -314,7 +291,7 @@
     if (strncmp (href, "data:", 5) == 0)
       return rsvg_decode_data_uri (href, mime_type, len, error);
 
-    if ((data = rsvg_acquire_file_data (href, base_uri, mime_type, len, cancellable, NULL)))
+    if ((data = rsvg_acquire_file_data (href, mime_type, len, cancellable, NULL)))
       return data;
 
     if ((data = rsvg_acquire_gvfs_data (href, base_uri, mime_type, len, cancellable, error)))

From 5fc44d9cf5e3b20ac06264d93554bd7fa701f788 Mon Sep 17 00:00:00 2001
From: Federico Mena Quintero <federico@gnome.org>
Date: Mon, 4 Dec 2017 18:29:46 -0600
Subject: [PATCH 10/10] Clean up rsvg-defs a bit

--- a/rsvg-defs.c	2019-08-12 11:24:30.655401324 -0700
+++ b/rsvg-defs.c	2019-08-12 11:27:36.378672057 -0700
@@ -52,52 +52,50 @@
     return result;
 }
 
-static int
-rsvg_defs_load_extern (const RsvgDefs * defs, const char *name)
+static RsvgHandle *
+rsvg_defs_load_extern (const RsvgDefs * defs, const char *uri)
 {
-    RsvgHandle *handle;
-    gchar *filename, *base_uri;
+    RsvgHandle *handle = NULL;
     char *data;
     gsize data_len;
-    gboolean rv;
 
-    filename = _rsvg_io_get_file_path (name, rsvg_handle_get_base_uri (defs->ctx));
+    data = _rsvg_handle_acquire_data (defs->ctx, uri, NULL, &data_len, NULL);
 
-    data = _rsvg_handle_acquire_data (defs->ctx, name, NULL, &data_len, NULL);
-
     if (data) {
         handle = rsvg_handle_new ();
 
-        base_uri = rsvg_get_base_uri_from_filename (filename);
-        rsvg_handle_set_base_uri (handle, base_uri);
-        g_free (base_uri);
+        rsvg_handle_set_base_uri (handle, uri);
 
-        rv = rsvg_handle_write (handle, (guchar *) data, data_len, NULL);
-        rv = rsvg_handle_close (handle, NULL) && rv;
-        if (rv) {
-            g_hash_table_insert (defs->externs, g_strdup (name), handle);
+        if (rsvg_handle_write (handle, (guchar *) data, data_len, NULL)
+            && rsvg_handle_close (handle, NULL)) {
+            g_hash_table_insert (defs->externs, g_strdup (uri), handle);
+        } else {
+            g_object_unref (handle);
+            handle = NULL;
         }
 
         g_free (data);
     }
 
-    g_free (filename);
-    return 0;
+    return handle;
 }
 
 static RsvgNode *
-rsvg_defs_extern_lookup (const RsvgDefs * defs, const char *filename, const char *name)
+rsvg_defs_extern_lookup (const RsvgDefs * defs, const char *possibly_relative_uri, const char *name)
 {
-    RsvgHandle *file;
-    file = (RsvgHandle *) g_hash_table_lookup (defs->externs, filename);
-    if (file == NULL) {
-        if (rsvg_defs_load_extern (defs, filename))
-            return NULL;
-        file = (RsvgHandle *) g_hash_table_lookup (defs->externs, filename);
-    }
+    RsvgHandle *handle;
+    char *uri;
 
-    if (file != NULL)
-        return g_hash_table_lookup (file->priv->defs->hash, name);
+    uri = rsvg_handle_resolve_uri (defs->ctx, possibly_relative_uri);
+    if (!uri)
+        return NULL;
+
+    handle = (RsvgHandle *) g_hash_table_lookup (defs->externs, uri);
+    if (handle == NULL)
+        handle = rsvg_defs_load_extern (defs, uri);
+
+    if (handle != NULL)
+        return g_hash_table_lookup (handle->priv->defs->hash, name);
     else
         return NULL;
 }
--- a/rsvg-io.c	2019-08-12 11:27:53.812939761 -0700
+++ b/rsvg-io.c	2019-08-12 11:28:19.138832351 -0700
@@ -324,7 +324,7 @@
         return g_memory_input_stream_new_from_data (data, len, (GDestroyNotify) g_free);
     }
 
-    if ((data = rsvg_acquire_file_data (href, base_uri, mime_type, &len, cancellable, NULL)))
+    if ((data = rsvg_acquire_file_data (href, mime_type, &len, cancellable, NULL)))
       return g_memory_input_stream_new_from_data (data, len, (GDestroyNotify) g_free);
 
     if ((stream = rsvg_acquire_gvfs_stream (href, base_uri, mime_type, cancellable, error)))
--- a/rsvg-io.h	2019-08-12 11:28:33.757477677 -0700
+++ b/rsvg-io.h	2019-08-12 11:28:48.380594944 -0700
@@ -26,10 +26,6 @@
 #include <glib.h>
 #include <gio/gio.h>
 
-G_GNUC_INTERNAL
-gchar *_rsvg_io_get_file_path (const gchar *filename, 
-                               const gchar *basedir);
-
 char *_rsvg_io_acquire_data (const char *uri,
 			     const char *base_uri,
 			     char **mime_type,
--- a/rsvg-base.c	2019-08-12 11:48:42.315300005 -0700
+++ b/rsvg-base.c	2019-08-12 11:48:54.588676312 -0700
@@ -2284,7 +2284,7 @@
 }
 
 gboolean
-rsvg_allow_load (GFile      *base_gfile,
+rsvg_allow_load (GFile   *base_gfile,
                          const char *uri,
                          GError **error)
 {
@@ -2294,8 +2294,6 @@
 
     g_assert (error == NULL || *error == NULL);
 
-    g_assert (handle->priv->load_policy == RSVG_LOAD_POLICY_STRICT);
-
     scheme = g_uri_parse_scheme (uri);
 
     /* Not a valid URI */
