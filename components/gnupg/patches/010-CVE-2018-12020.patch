# Fix from upstream.  Fix is also included in gnupg 2.2.8
# https://lists.gnupg.org/pipermail/gnupg-announce/2018q2/000425.html 
# CVE-2018-12020 Sanitize diagnostic with the original file name
#
#
# http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-12020
# https://dev.gnupg.org/rG13f135c7a252cc46cff96e75968d92b6dc8dce1b#9e86f1a6
#
#
diff -rupN old/g10/mainproc.c new/g10/mainproc.c
--- old/g10/mainproc.c	2018-06-11 12:24:10.213209236 +0000
+++ new/g10/mainproc.c	2018-06-11 13:34:30.761315453 +0000
@@ -628,7 +628,15 @@ proc_plaintext( CTX c, PACKET *pkt )
     if( pt->namelen == 8 && !memcmp( pt->name, "_CONSOLE", 8 ) )
 	log_info(_("NOTE: sender requested \"for-your-eyes-only\"\n"));
     else if( opt.verbose )
-	log_info(_("original file name='%.*s'\n"), pt->namelen, pt->name);
+    {
+	/* We don't use print_utf8_buffer because that would require a
+	 * string change which we don't want in 2.2.  It is also not
+	 * clear whether the filename is always utf-8 encoded.  */
+	char *tmp = make_printable_string (pt->name, pt->namelen, 0);
+	log_info (_("original file name='%.*s'\n"), (int)strlen (tmp), tmp);
+	xfree (tmp);
+    }
+ 
     free_md_filter_context( &c->mfx );
     if (gcry_md_open (&c->mfx.md, 0, 0))
       BUG ();
